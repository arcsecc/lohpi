syntax = "proto3";
import "google/protobuf/timestamp.proto";
package proto;

service DirectoryServer {
    rpc Handshake (Node) returns (HandshakeResponse) {}
    //rpc IgnoreIP (Node) returns (Node) {}
}

service PolicyStore {
    rpc Handshake (Node) returns (HandshakeResponse) {}
}

message Client {
    string name = 1;
    bytes policyAttribute = 2;
}

// Used in direct messaging
message Message {
    string Type = 1;        // What kind of message is it?
    Node sender = 2;        //
    Policy policy = 3;      //
    MsgSignature signature = 5; // Integrity check based on ECDSA
    GossipMessage gossipMessage = 6;
    Probe probe = 7;
    DatasetRequest datasetRequest = 8;
    DatasetResponse datasetResponse = 9;
    PolicyRequest policyRequest = 10;
    PolicyResponse policyResponse = 11;

    // Other fields
    string stringValue = 14;
    repeated string stringSlice = 15;  // Arbitrary ue
    bytes Bytes = 16;
    repeated bytes BytesSlice = 17;
    bool boolValue = 18;
}

message Response {
    MsgSignature signature = 1;// Integrity check based on ECDSA
    string stringValue = 2;
    repeated string stringSlice = 3;  // Arbitrary use
    bytes bytesValue = 4;
    repeated bytes bytesSlice = 5;
}

// Here, node is Lohpi storage nodes, policy store and mux (and compliance engine?)
message Node {
    string name = 1;            // String identifier
    string ifritAddress = 2;         // IP address
    string role = 3;            // What type of node is it? storage node, compliance engine etc
    string contactEmail = 4;   // Contact of person/entity responsible for the node, preferably an email alias, for non-compliance reports. 
    bytes id = 5;              // Ifrit id
    string httpAddress = 6; //
}

message DatasetRequest {
    string identifier = 1;          // String identifier
    bytes clientToken = 2;    // access attribute from client
    MsgSignature signature = 3;
}

message DatasetResponse {
    string Type = 1;        // zip/gzip/binary...
    string URL = 2;
    bool isAllowed = 3;
    string errorMessage = 4;
    MsgSignature signature = 5;
}

message PolicyRequest {
    string identifier = 1;
}

// TODO: specify policies here
message PolicyResponse {
    Policy objectPolicy = 1;
    MsgSignature signature = 2;
}

message MetadataRequest {
    string identifier = 1;          // String identifier
    bytes clientToken = 2;    // access attribute from client
    MsgSignature signature = 3;
}

message MetadataResponse {
    string URL = 1;
    MsgSignature signature = 2;
}

message Policy {
    string issuer = 1;
    string objectIdentifier = 2;
    string content = 3; // Policy details. See Casbin policy 
}

message MsgSignature {
    bytes r = 1;
    bytes s = 2;
}

message HandshakeResponse {
    string ip = 1;  // IP of the node owner
    bytes id = 2;   // From fireflies
}

// Fix later
message GossipMessage {
    string Sender = 1;              // Who sent it?
    string MessageType = 2;         // Gossip or probing?
    google.protobuf.Timestamp timestamp = 3; // Time at policy store, to keep track of messages     
    MsgSignature signature = 4;
    repeated GossipMessageBody gossipMessageBody = 5;   
}

message GossipMessageBody {
    string objectId = 1;          // subject or study. Appliy the policy to the object
    uint64 version = 2;         // Version numbering 
    Policy policy = 3;
    google.protobuf.Timestamp timestamp = 4; // Time at policy store at the time of arrival
}

message Probe {
    uint32 order = 1;
    bytes sessionId = 2;
}